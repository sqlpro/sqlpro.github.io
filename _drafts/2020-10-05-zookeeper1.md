---
title: 분산 리소스 코디네이터 주키퍼(Zookeeper)
layout: post
tags:
- 분산시스템
- 주키퍼
- 코디네이터
---

대규모 분산 시스템을 구축할 때 고민해야 하는 이슈들은 생각보다 많다. 안정적인 운영과 대용량 처리를 위해서는 **단일 장애점(Single Point of Failure)** 이 없어야 하고, 효율적인 분산 처리가 가능해야 한다. 서비스에 문제가 잦아 신뢰할 수 없거나 분산 처리를 했음에도 뚜렷한 성능 향상을 보여주지 못한다면, 분산 시스템을 사용하지 않는 편이 낫다. 

이 때문에 대규모 분산 시스템을 구축할 때에는 분산된 서버들의 상태를 어떻게 체크할 것인지, 서버 간의 정보를 어떻게 공유할것인지, 그리고 서버별 동기화를 위한 글로벌 락(Global Lock) 처리를 어떻게 할 것인지 등을 잘 고민해서 설계해야 한다.  하지만 사실 이런 시스템을 잘 만들기란 쉽지 않다. 도메인 로직보다 분산 관리 시스템 구축에 더 많은 시간과 노력을 쏟을 가능성이 존재하기도 하고. 

다행히 이런 문제를 해결하기 위한 시스템이 있는데, 바로 코디네이션 시스템(Coordination System)이다. 해석하자면 분산 관리 시스템으로, 아파치 주키퍼(Apache Zookeeper, 이하 주키퍼)가 대표적이다. 

주키퍼는 분산 코디네이션 서비스를 제공하는 오픈 소스 프로젝트이다. 분산된 서버 노드를 관리하고 서버 간 정보를 서로 공유하며, 서버 상태를 체크하는데 최적화된 어플리케이션이라고 할 수 있다. 

분산 시스템 전체를 하나의 학급으로 간주하고 서버 노드를 학생들로 본다면, 주키퍼는 출결 상황을 관리하는 출석부에 해당한다.   

![](https://img1.daumcdn.net/thumb/R800x0/?scode=mtistory2&fname=https%3A%2F%2Ft1.daumcdn.net%2Fcfile%2Ftistory%2F214EF0485383E58E11)

## 주키퍼의 특징
코디네이션 서비스는 분산 시스템 내에서 상태 정보나 설정 정보를 유지하는 등 중요한 역할을 한다. 따라서 코디네이션 서비스의 장애는 곧 전체 시스템의 장애로 이어질 가능성이 있다. 따라서 이중화 등을 통해 고가용성을 제공해야 한다. 

주키퍼는 이를 잘 반영한 프로젝트이다. 분산 시스템을 코디네이션하기 위해 데이터 엑세스가 빠르며 장애 대응을 위해 클러스터링 기능을 지원한다. 설령 장애가 발생했다 하더라도 데이터 유실이 발생하지 않도록 Fail Over / Fail Back이 가능하게 설계되어 있다. 이와 같은 안전 장치들 때문에 널리 알려진 분산 기반 솔루션에 사용된다. NoSQL의 하나인 HBase, 하둡, 대용량 메시지 큐 시스템인 카프카(Kafka), 컨테이너 오케스트레이션 시스템인 쿠버네티스(Kubernetes) 등이 대표적인 사례이다. 

## 주키퍼의 구조 
주키퍼는 서버와 클라이언트로 나누어진다. 서버는 독립적인 어플리케이션으로 실행되는 반면, 다수의 클라이언트는 컴포넌트 형태로 노드에 삽입되어 주키퍼 서버와의 연결을 담당하는 구조로 동작한다. 


분산 시스템을 관리하는 어플리케이션이라고 앞서 설명했지만, 사실 주키퍼의 기능은 꽤 단순하다.  Znode라고 불리는 Key-Value 형태의 데이터 저장 객체를 제공하고, 이 객체에 데이터를 넣고 빼는 기능을 제공하며, 클라이언트의 상태가 변경되었을 때 지정된 이벤트 리스너에 이를 알려주는 정도가 전부이다. 다만 Znode의 저장 특성을 이용하면 서버 상태 관리나 서버 정보 공유같은 단순한 기능 외에도 분산 락 구현과 같은 다양한 기능을 활용할 수 있다.  

## Znode 종류
znode는 디렉토리 형식으로 관리되므로, 계층 구조로 데이터를 관리하기가 용이하다. 

Persistent Node : 노드에 데이타를 저장하면 일부러 삭제하지 않는 이상 삭제되지 않고 영구히 저장된다.

Ephemeral Node : 노드를 생성한 클라이언트의 세션이 연결되어 있을 경우만 유효하다. 즉 클라이언트 연결이 끊어지는 순간 삭제 된다. 이를 통해서 클라이언트가 연결이 되어 있는지 아닌지를 판단하는데 사용할 수 있다. (클러스터를 구성할때 클러스터내에 서버가 들어오면, 이 Ephemeral Node로 등록하면 된다.)

Sequence Node : 노드를 생성할때 자동으로 sequence 번호가 붙는 노드이다. 주로 분산락을 구현하는데 이용된다.



주키퍼 서버는 클라이언트에서 오는 연결 요청을 받아 저장하고, 주기적으로 연결 여부를 확인한다(이를 헬스체크Health Check라고 한다). 만약 특정 노드에 문제가 생겨 연결이 끊어진다면, 주키퍼 서버는 이를 감지하여 등록된 이벤트 리스너로 전송한다. 이를 이용하여 분산 시스템 내 노드의 상태 변경을 감지할 수 있다. 노드가 신규로 추가된 경우도 마찬가지이다. 만약 이벤트 리스너에다 분산 정책 갱신 로직을 작성해둔다면 노드에 문제가 생겼거나 신규 노드가 추가되었을 때마다 분산 정책이 갱신될 것이다. 





## 주키퍼의 특성
